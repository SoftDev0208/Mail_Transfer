<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Send HTML Template</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <style>
    body {
      font-family: system-ui;
      max-width: 1100px;
      margin: 30px auto;
      padding: 0 16px;
      background: #ffffff;
    }

    input, select, button {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ddd;
    }

    button {
      cursor: pointer;
      background: #2563eb;
      color: white;
      font-weight: 600;
      border: none;
    }

    button:hover {
      opacity: 0.9;
    }

    .btnSmall {
      width: auto;
      padding: 6px 12px;
      font-size: 14px;
      border-radius: 6px;
      background: #111827;
      color: white;
      border: none;
      cursor: pointer;
    }

    .btnSmall:hover {
      opacity: 0.85;
    }

    .status {
      white-space: pre-wrap;
      margin-top: 12px;
      font-size: 14px;
      padding: 10px;
      background: #f8fafc;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1.2fr;
      gap: 18px;
      align-items: start;
    }

    .card {
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 16px;
      background: white;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 14px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
      font-size: 14px;
    }

    th {
      background: #f1f5f9;
    }

    .ok {
      color: green;
      font-weight: 700;
    }

    .bad {
      color: #b00020;
      font-weight: 700;
    }

    .title {
      font-size: 22px;
      font-weight: 800;
      margin-bottom: 10px;
    }

    label {
      font-weight: 600;
      display: block;
      margin-top: 6px;
    }

    .hint {
      font-size: 13px;
      color: #475569;
      margin-top: -4px;
      margin-bottom: 10px;
    }
  </style>
</head>

<body>
  <div class="title">üì® Bulk Email Sender (HTML Upload)</div>

  <div class="row">
    <!-- LEFT SIDE -->
    <div class="card">
      <label>From Name</label>
      <input id="fromName" placeholder="ZAMA Support" value="ZAMA Support" />
      <div class="hint">This is the display name shown in mailbox.</div>

      <label>From Email</label>
      <input id="fromEmail" type="email" placeholder="your@gmail.com" />
      <div class="hint">Usually should match SMTP_USER (Gmail will enforce it).</div>

      <label>Mode</label>
      <select id="mode">
        <option value="individual" selected>Individual (recommended, shows status)</option>
        <option value="bcc">BCC (single email, no per-user status)</option>
      </select>

      <label>Subject</label>
      <input id="subject" placeholder="Subject..." />

      <label>HTML file</label>
      <input id="template" type="file" accept=".html,.htm,text/html" />

      <button id="sendBtn">Send Email</button>

      <div class="status" id="status">Ready.</div>
    </div>

    <!-- RIGHT SIDE -->
    <div class="card">
      <h3>üìå Sent Status</h3>

      <div class="status" id="summary">No sends yet.</div>

      <table id="resultsTable" style="display:none">
        <thead>
          <tr>
            <th>Email</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>

        <tbody id="resultsBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const statusEl = document.getElementById("status");
    const summaryEl = document.getElementById("summary");
    const tableEl = document.getElementById("resultsTable");
    const bodyEl = document.getElementById("resultsBody");

    function getFormValues() {
      return {
        fromName: document.getElementById("fromName").value.trim(),
        fromEmail: document.getElementById("fromEmail").value.trim(),
        subject: document.getElementById("subject").value.trim(),
        mode: document.getElementById("mode").value,
        file: document.getElementById("template").files[0]
      };
    }

    function renderResults(results, subject) {
      bodyEl.innerHTML = "";
      tableEl.style.display = "table";

      for (const r of results) {
        const tr = document.createElement("tr");

        const tdEmail = document.createElement("td");
        tdEmail.textContent = r.to;

        const tdStatus = document.createElement("td");
        tdStatus.innerHTML = r.ok
          ? `<span class="ok">SENT</span>`
          : `<span class="bad">FAILED</span>` + (r.error ? ` ‚Äî ${r.error}` : "");

        const tdAction = document.createElement("td");

        if (r.ok) {
          tdAction.textContent = "-";
        } else {
          const btn = document.createElement("button");
          btn.className = "btnSmall";
          btn.textContent = "Resend";
          btn.onclick = () => resendOne(r.to, subject, tr);
          tdAction.appendChild(btn);
        }

        tr.appendChild(tdEmail);
        tr.appendChild(tdStatus);
        tr.appendChild(tdAction);

        bodyEl.appendChild(tr);
      }

      const sentCount = results.filter(x => x.ok).length;
      summaryEl.textContent = `Sent: ${sentCount}/${results.length}`;
    }

    async function resendOne(to, subject, rowEl) {
      const { fromName, fromEmail, file } = getFormValues();

      if (!file) {
        alert("Please select the same HTML file again before resending.");
        return;
      }

      const statusCell = rowEl.children[1];
      const actionCell = rowEl.children[2];

      statusCell.innerHTML = "Resending...";
      actionCell.innerHTML = "";

      const form = new FormData();
      form.append("to", to);
      form.append("subject", subject);
      form.append("fromName", fromName);
      form.append("fromEmail", fromEmail);
      form.append("template", file);

      try {
        const res = await fetch("/api/send-one", {
          method: "POST",
          body: form
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Resend failed");

        statusCell.innerHTML = `<span class="ok">SENT</span>`;
        actionCell.textContent = "-";
      } catch (e) {
        statusCell.innerHTML = `<span class="bad">FAILED</span> ‚Äî ${e.message}`;

        const btn = document.createElement("button");
        btn.className = "btnSmall";
        btn.textContent = "Resend";
        btn.onclick = () => resendOne(to, subject, rowEl);

        actionCell.appendChild(btn);
      }
    }

    document.getElementById("sendBtn").onclick = async () => {
      const { fromName, fromEmail, subject, mode, file } = getFormValues();

      if (!fromName) {
        statusEl.textContent = "‚ùå From Name required.";
        return;
      }

      if (!fromEmail) {
        statusEl.textContent = "‚ùå From Email required.";
        return;
      }

      if (!subject) {
        statusEl.textContent = "‚ùå Subject required.";
        return;
      }

      if (!file) {
        statusEl.textContent = "‚ùå Please choose an HTML file.";
        return;
      }

      const form = new FormData();
      form.append("fromName", fromName);
      form.append("fromEmail", fromEmail);
      form.append("subject", subject);
      form.append("mode", mode);
      form.append("template", file);

      statusEl.textContent = "Sending...";
      summaryEl.textContent = "Waiting for results...";
      tableEl.style.display = "none";
      bodyEl.innerHTML = "";

      try {
        const res = await fetch("/api/send", {
          method: "POST",
          body: form
        });

        const data = await res.json();

        if (!res.ok) {
          statusEl.textContent = "‚ùå " + (data.error || "Send failed");
          if (data.details) statusEl.textContent += "\n" + data.details;
          summaryEl.textContent = "No results.";
          return;
        }

        statusEl.textContent = "‚úÖ Send finished.";

        if (data.mode === "bcc") {
          summaryEl.textContent =
            `BCC sent to ${data.accepted} recipients.\n(No per-user status available in BCC mode)`;
          tableEl.style.display = "none";
          return;
        }

        renderResults(data.results || [], subject);

      } catch (e) {
        statusEl.textContent = "‚ùå Request failed: " + e.message;
        summaryEl.textContent = "No results.";
      }
    };
  </script>
</body>
</html>
