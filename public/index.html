<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Bulk Email Sender</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui; max-width: 1100px; margin: 30px auto; padding: 0 16px; }
    .row { display:grid; grid-template-columns: 1fr 1.4fr; gap: 18px; align-items:start; }
    .card { border:1px solid #ddd; border-radius:12px; padding:16px; background:#fff; }
    input, button { width:100%; padding:10px; margin:8px 0; font-size:16px; border-radius:8px; border:1px solid #ddd; }
    button { cursor:pointer; background:#2563eb; color:#fff; font-weight:700; border:none; }
    button:hover { opacity:0.9; }
    .btnSmall { width:auto; padding:6px 10px; font-size:14px; border-radius:6px; background:#111827; }
    .btnSmall:hover { opacity:0.85; }
    .status { white-space:pre-wrap; padding:10px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; font-size:14px; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td { border:1px solid #ddd; padding:10px; text-align:left; font-size:14px; }
    th { background:#f1f5f9; }
    .ok { color:green; font-weight:800; }
    .bad { color:#b00020; font-weight:800; }
    .muted { color:#64748b; font-size:13px; margin-top:-4px; }
    label { font-weight:700; display:block; margin-top:6px; }
  </style>
</head>
<body>
  <h1>üì® Bulk Email Sender (HTML Upload + DB Status)</h1>

  <div class="row">
    <div class="card">
      <label>From Name</label>
      <input id="fromName" placeholder="ZAMA Support" value="ZAMA Support" />

      <label>From Email</label>
      <input id="fromEmail" type="email" placeholder="your@gmail.com" />
      <div class="muted">Tip: For Gmail, From Email should match SMTP_USER.</div>

      <label>Subject</label>
      <input id="subject" placeholder="Subject..." />

      <label>HTML file</label>
      <input id="template" type="file" accept=".html,.htm,text/html" />

      <button id="sendBtn">Send to all (individual)</button>

      <div class="status" id="status">Ready.</div>
    </div>

    <div class="card">
      <div style="display:flex; gap:10px; align-items:center; justify-content:space-between;">
        <h3 style="margin:0;">üìå Database Status</h3>
        <button class="btnSmall" id="refreshBtn">Refresh</button>
      </div>

      <div class="status" id="summary">Loading‚Ä¶</div>

      <table id="dbTable" style="display:none;">
        <thead>
          <tr>
            <th>Email</th>
            <th>Valid</th>
            <th>Sent</th>
            <th>Read</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="dbBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const statusEl = document.getElementById("status");
    const summaryEl = document.getElementById("summary");
    const dbTable = document.getElementById("dbTable");
    const dbBody = document.getElementById("dbBody");

    function vals() {
      return {
        fromName: document.getElementById("fromName").value.trim(),
        fromEmail: document.getElementById("fromEmail").value.trim(),
        subject: document.getElementById("subject").value.trim(),
        file: document.getElementById("template").files[0],
      };
    }

    function badge(v) {
      return v ? `<span class="ok">1</span>` : `<span class="bad">0</span>`;
    }

    async function loadStatus() {
      summaryEl.textContent = "Loading‚Ä¶";
      dbTable.style.display = "none";
      dbBody.innerHTML = "";

      const res = await fetch("/api/status");
      const data = await res.json();
      if (!res.ok) {
        summaryEl.textContent = "‚ùå " + (data.error || "Failed");
        return;
      }

      const rows = data.rows || [];
      const sent = rows.filter(r => Number(r.is_sent) === 1).length;
      const read = rows.filter(r => Number(r.is_read) === 1).length;
      const valid = rows.filter(r => Number(r.is_valid) === 1).length;

      summaryEl.textContent = `Rows: ${rows.length} | Valid: ${valid} | Sent: ${sent} | Read: ${read}`;

      dbTable.style.display = "table";

      for (const r of rows) {
        const tr = document.createElement("tr");

        const tdEmail = document.createElement("td");
        tdEmail.textContent = r.email;

        const tdValid = document.createElement("td");
        tdValid.innerHTML = badge(Number(r.is_valid) === 1);

        const tdSent = document.createElement("td");
        tdSent.innerHTML = badge(Number(r.is_sent) === 1);

        const tdRead = document.createElement("td");
        tdRead.innerHTML = badge(Number(r.is_read) === 1);

        const tdAction = document.createElement("td");
        if (Number(r.is_sent) === 1) {
          tdAction.textContent = "-";
        } else {
          const btn = document.createElement("button");
          btn.className = "btnSmall";
          btn.textContent = "Resend";
          btn.onclick = () => resend(r.email, tr);
          tdAction.appendChild(btn);
        }

        tr.appendChild(tdEmail);
        tr.appendChild(tdValid);
        tr.appendChild(tdSent);
        tr.appendChild(tdRead);
        tr.appendChild(tdAction);

        dbBody.appendChild(tr);
      }
    }

    async function resend(email, rowEl) {
      const { fromName, fromEmail, subject, file } = vals();

      if (!subject) { alert("Subject required"); return; }
      if (!file) { alert("Please select the same HTML file to resend."); return; }

      const sentCell = rowEl.children[2];
      const actionCell = rowEl.children[4];

      sentCell.innerHTML = "Resending...";
      actionCell.innerHTML = "";

      const form = new FormData();
      form.append("to", email);
      form.append("subject", subject);
      form.append("fromName", fromName);
      form.append("fromEmail", fromEmail);
      form.append("template", file);

      try {
        const res = await fetch("/api/send-one", { method: "POST", body: form });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Resend failed");

        await loadStatus();
      } catch (e) {
        sentCell.innerHTML = `<span class="bad">0</span>`;
        const btn = document.createElement("button");
        btn.className = "btnSmall";
        btn.textContent = "Resend";
        btn.onclick = () => resend(email, rowEl);
        actionCell.appendChild(btn);
        alert("Resend failed: " + e.message);
      }
    }

    document.getElementById("refreshBtn").onclick = loadStatus;

    document.getElementById("sendBtn").onclick = async () => {
      const { fromName, fromEmail, subject, file } = vals();

      if (!fromName) { statusEl.textContent = "‚ùå From Name required."; return; }
      if (!fromEmail) { statusEl.textContent = "‚ùå From Email required."; return; }
      if (!subject) { statusEl.textContent = "‚ùå Subject required."; return; }
      if (!file) { statusEl.textContent = "‚ùå Please choose an HTML file."; return; }

      const form = new FormData();
      form.append("fromName", fromName);
      form.append("fromEmail", fromEmail);
      form.append("subject", subject);
      form.append("template", file);

      statusEl.textContent = "Sending to all...";
      try {
        const res = await fetch("/api/send", { method: "POST", body: form });
        const data = await res.json();

        if (!res.ok) {
          statusEl.textContent = "‚ùå " + (data.error || "Send failed");
          if (data.details) statusEl.textContent += "\n" + data.details;
          return;
        }

        statusEl.textContent = `‚úÖ Finished. Sent ${data.sent}/${data.total}.`;
        await loadStatus();
      } catch (e) {
        statusEl.textContent = "‚ùå Request failed: " + e.message;
      }
    };

    loadStatus();
  </script>
</body>
</html>
